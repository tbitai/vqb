<!DOCTYPE html>
<html ng-app="VqbApp">
    <head>
        <title>Virtual QB</title>
        <meta charset="UTF-8">
        
        <!-- 
        <meta name="viewport" content="width=820, initial-scale=1.0">
        -->
        
        <meta property="og:title" content="Virtual QB" />
        <meta property="og:image" content="http://tbitai.github.io/vqb.png" />
        <meta property="og:description" content="Rotate the cubes, or draw on them!" />
        
        <!-- Facebook admin for Insights -->
        <meta property="fb:admins" content="1634121238" />
        
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.6/angular.min.js"></script>
 
        <!--
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.6/angular-resource.min.js"> </script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.6/angular-route.min.js"></script>
        -->
   
        <script src='https://cdn.firebase.com/js/client/1.0.11/firebase.js'></script>
        <script src='https://cdn.firebase.com/libs/angularfire/0.7.1/angularfire.min.js'></script>
        
        <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
        
        <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Passion+One:400,900' rel='stylesheet' type='text/css'>
        <style>
            table{
                margin-left:auto;
                margin-right:auto;
            }
            td{
                padding: 6px;
            }
            h1{
                font-family: "Passion One"; font-weight: 900;
                text-transform: uppercase;
                font-size: 37px;
            }
            .lead{
                font-family: "Lobster";
                font-size: 19px;
            }
            .fb-like{
                margin-top: 6px;
            }
            .container {
                width: 880px; /* (60 + 16 + 2 * 6) * 10 */
            } 
        </style>
    </head>
    <body>
        <div id="fb-root"></div>
        <script>
                (function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.0";
            fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
        </script>

        <div class="container">     
            <div class="row">
                <div class="text-center col-xs-6 col-xs-offset-3">            
                    <h1>Virtual QB</h1>
                    <p class="lead">Rotate the cubes, or draw on them!</p>
                </div>
                <div class="col-xs-1 col-xs-offset-2">
                    <div class="fb-like"
                        data-href="http://tbitai.github.io/vqb/"
                        data-width="120"
                        data-layout="box_count"
                        data-action="like"
                        data-show-faces="true"
                        data-share="true">
                    </div>
                </div>
            </div>
            <div class="row">
                <table ng-controller="ListAndEditCtrl">
                    <tr ng-repeat="cubeRow in vqb.cubes">
                        <td ng-repeat="cube in cubeRow">
                            <canvas width="60" height="16"
                                    style="background-color: #333;
                                   -ms-transform: skew(-45deg,0deg); /* IE 9 */
                                   -webkit-transform: skew(-45deg,0deg); /* Chrome, Safari, Opera */
                                   transform: skew(-45deg,0deg);
                                   display:block;
                                   position: relative; left: 8px; /* adjust bottom side to the front face */"></canvas>

                            <div id="frontAndRightFaceContainer">
                                <svg width="60" height="60"
                                     style="float:left;
                            cursor: crosshair;"
                                     ng-init="drawingInit()"
                                     ng-mousedown="drawingMouseDownHandler(cube,$event)"
                                     ng-mouseup="drawingMouseUpAndMouseLeaveHandler()"
                                     ng-mouseleave="drawingMouseUpAndMouseLeaveHandler()"
                                     ng-mousemove="drawLine(cube,$event,mouseDown,lastPoint)">
                                <rect x="0" y="0" width="60" height="60" ng-attr-fill="{{vqb.bgcolors[cube.activeface]}}"></rect>
                                <rect ng-repeat="point in cube.faces[cube.activeface].points"
                                        ng-attr-x="{{point.x}}"
                                        ng-attr-y="{{point.y}}"
                                        width="1"
                                        height="1"
                                        ng-attr-fill="{{point.color}}" />                                        
                                </svg>
                                <canvas height="60" width="16"
                                        style="background-color: {{vqb.bgcolors[faceToRight(cube.activeface)]}};
                                   -ms-transform: skew(0deg,-45deg); /* IE 9 */
                                   -webkit-transform: skew(0deg,-45deg); /* Chrome, Safari, Opera */
                                   transform: skew(0deg,-45deg);
                                   position: relative; top: -8px; /* adjust left side to the front face */
                                   cursor:pointer;"
                                        ng-click="rotateRight(cube)"></canvas>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="text-center">
                <p>
                    A project by <a href="http://tbitai.github.io/">Tamás Bitai</a>.
                </p>
                <p><a href='http://szinesvaros.hu/index.php/en/projects/item/11-bp-v-erzsebet-ter'>QB</a>
                    was a funny thing at Erzsébet Square, Budapest.
                </p>
            </div>
        </div>
        <script>
            angular.module('VqbApp', ['firebase'])
 
.value('fbURL', 'https://vqb.firebaseio.com/')
 
.factory('VQB', function($firebase, fbURL) {
  return $firebase(new Firebase(fbURL));
})
    
 
.controller('ListAndEditCtrl', function($scope, VQB) {
  //$scope.vqb = VQB;
  /// We make a 3-way binding instead,
  /// so that later we don't have to bother with updating
  /// Firebase as well.
  VQB.$bind($scope,'vqb');
  
  $scope.faceToRight=function(s){
      if (s==3)
          return 0;
      else
          return s+1;     
  }
  
  $scope.rotateRight=function(c){
      c.activeface = $scope.faceToRight(c.activeface);
  }

  $scope.drawingInit = function(){
      $scope.mouseDown=0;
      $scope.lastPoint=null;
  }
  
  $scope.drawingMouseDownHandler = function(c,e){
      $scope.mouseDown=1;
      $scope.drawLine(c,e,$scope.mouseDown,$scope.lastPoint);
  }
  
  $scope.drawingMouseUpAndMouseLeaveHandler = function(){
      $scope.mouseDown=0;
      $scope.lastPoint=null;
  }
  
  $scope.drawLine=function(c,e,m,l){
      
      if (!m) return;
      
      e.preventDefault();
      
      // Create points array if it doesn't exist
      if (c.faces[c.activeface].points===undefined)
          c.faces[c.activeface].points=[];
      
      // Define offsetX and offsetY for Firefox
      if(typeof e.offsetX === "undefined" || typeof e.offsetY === "undefined") {
        var targetOffset = $(e.target).offset();
        e.offsetX = e.pageX - targetOffset.left;
        e.offsetY = e.pageY - targetOffset.top;
      }
      
      // Bresenham's line algorithm
      // (Idea and code stolen from the Firebase tutorial's Drawing Example.)
      var x1 = e.offsetX;
      var y1 = e.offsetY;
      var x0 = (l == null) ? x1 : l[0];
      var y0 = (l == null) ? y1 : l[1];
      var dx = Math.abs(x1 - x0), dy = Math.abs(y1 - y0);
      var sx = (x0 < x1) ? 1 : -1, sy = (y0 < y1) ? 1 : -1, err = dx - dy;
      while (true) {
        c.faces[c.activeface].points.push({"x":x0, "y":y0, "color":"#333"});
        if (x0 == x1 && y0 == y1) break;
        var e2 = 2 * err;
        if (e2 > -dy) {
          err = err - dy;
          x0 = x0 + sx;
        }
        if (e2 < dx) {
          err = err + dx;
          y0 = y0 + sy;
        }
      }
      l = [x1, y1];
  }
})
        </script>
    </body>
</html>
